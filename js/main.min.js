!function(e){"use strict";e(function(){function t(e,t){var i=e.offset().left,n=e.offset().top,o=e.outerHeight(!0),l=e.outerWidth(!0),s=n+o,a=i+l,r=t.offset().left,c=t.offset().top,d=t.outerHeight(!0),h=t.outerWidth(!0),u=c+d,p=r+h;return c>s||n>u||r>a||i>p?!1:!0}var i=i||{};i.Data=Backbone.Model.extend({defaults:{title:"Your title here",permalink:"",content:{},meta:{}}}),e.get(ajaxurl,{action:"get_cb_button_tpl"}).done(function(e){i.blocksBtn_tpl=e,i.blockMenu=new i.BlocksContainerView({collection:i.blocksCol})}),i.Uploader=Backbone.Model.extend({initialize:function(){this.params={browse_button:this.get("browse_button"),container:this.get("container"),drop_element:this.get("drop_element"),multi_selectioni:this.get("multi_selectioni")},this.$settings=_.extend({},this.get("defaults"),this.params),this.response={},this.instance=new plupload.Uploader(this.$settings),this.init()},init:function(){var e=this,t=e.instance;setTimeout(function(){t.init(),t.bind("FilesAdded",_.bind(e.filesAdded,this)),t.bind("QueueChanged",_.bind(e.queueChanged,this)),t.trigger("DisableBrowse",!0)},10)},logIt:function(){console.log(this.instance)},filesAdded:function(e){e.start()},queueChanged:function(e){e.start(),e.refresh()}}),i.BlockModel=Backbone.Model.extend(),i.BlocksContainer=Backbone.Collection.extend({url:ajaxurl,model:i.BlockModel,group:function(e){return _(this.filter(function(t){return t.get("group")==e}))},search:function(e){if(""==e)return this;var t=new RegExp(e,"gi");return _(this.filter(function(e){return t.test(e.get("name"))}))}}),i.blocksCol=new i.BlocksContainer,i.BlockButton=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(i.blocksBtn_tpl),this.render()},render:function(){return this.$el.html(this.template({name:this.model.get("name"),slug:this.model.get("slug"),icon:this.model.get("icon"),view:this.model.get("view")})),this}}),i.BlocksContainerView=Backbone.View.extend({el:"#blocksSelect",events:{"keyup #blocks-search":"search","click .customBlock":"addBlock"},initialize:function(){_.bindAll(this,"render"),this.listenTo(this.collection,"reset",this.render),this.defaults=e("#defaults-container"),this.others=e("#others-container"),this.results=e("#results-container");var t={action:"get_content_blocks"},i=this;this.collection.fetch({data:e.param(t),success:function(){i.defaultBlocks=i.collection.group("default"),i.otherBlocks=i.collection.group("other"),i.render()},error:function(e,t){console.log(" Service request failure: "+e),console.log(t.responseText)}})},render:function(){var e=this;e.defaults.html("").append("<h3>Default Blocks</h3>"),e.others.html("").append("<h3>Other Blocks</h3>"),e.defaultBlocks.each(function(t){var n=new i.BlockButton({model:t});e.defaults.append(n.render().el)}),e.otherBlocks.each(function(t){var n=new i.BlockButton({model:t});e.others.append(n.render().el)})},renderList:function(e){this.defaults.html(""),this.others.html(""),this.results.html("");var t=this;e.each(function(e){var n=new i.BlockButton({model:e,collection:t.collection});t.results.append(n.render().el)})},search:function(t){var i=e(t.target).val();i?this.renderList(this.collection.search(i)):(this.results.html(""),this.render())},addBlock:function(t){var n=this.collection.findWhere({slug:e(t.currentTarget).attr("data-type")}),o=n.get("slug"),l=n.get("view");i.view.addBlock(o,l)}}),i.Block=Backbone.Model.extend({defaults:{wp_id:0,remove:!0,move:!0}}),i.Blocks=Backbone.Collection.extend({model:i.Block}),i.blocks=new i.Blocks,i.BlockView=Backbone.View.extend({tagName:"div",className:"content-block",tpl:"#wp-text",isEditable:!1,events:{"click .remove":"destroy","click .move-up":"moveUp","click .move-down":"moveDown"},init:function(){},beforeRender:function(){},afterRender:function(){},initialize:function(){this.beforeRender(),this.trigger("beforeRender"),this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(e(this.tpl).html()),this.events&&(this.events=_.defaults(this.events,i.BlockView.prototype.events)),this.delegateEvents(this.events),this.init(),this.render(),this.afterRender(),this.trigger("afterRender")},render:function(){return this.$el.html(this.template({wp_id:this.model.get("wp_id"),block_type:this.model.get("type"),block_content:this.model.get("body"),remove:this.model.get("remove"),move:this.model.get("move"),editable:this.isEditable})),this},unrender:function(){this.$el.remove()},destroy:function(){this.model.destroy()},moveUp:function(t){var i=e(t.currentTarget).parents(".content-block"),n=i.prev(".content-block");n.insertAfter(i)},moveDown:function(t){var i=e(t.currentTarget).parents(".content-block"),n=i.next(".content-block");n.insertBefore(i)}}),i.textView=i.BlockView.extend({tpl:"#wp-text",isEditable:!0}),i.quoteView=i.BlockView.extend({tpl:"#wp-quote"}),i.codeView=i.BlockView.extend({tpl:"#wp-code",isEditable:!0,init:function(){console.log(this.model)}}),i.embedView=i.BlockView.extend({tpl:"#wp-embed"}),i.tweetView=i.BlockView.extend({tpl:"#wp-tweet"}),i.imgView=i.BlockView.extend({tpl:"#wp-image",events:{"click .open-modal":"mediaModal","click .remove-img":"removeImg","click .opt-size":"imgSize","click .opt-align":"imgAlign","dragover .drag-drop":"dragOver","dragleave .drag-drop":"dragLeave","drop .drag-drop":"dropUpload"},init:function(){this.imgSizes={},this.blockType=this.model.get("type")},afterRender:function(){var e=this.model.get("wp_id");this.upl=new i.Uploader({browse_button:"wp-browse-button-"+e,container:"wp-img-ui-"+e,drop_element:"wp-drag-drop-"+e,multi_selection:!1,defaults:ceux_plupload}),this.upl.instance.bind("FilesAdded",_.bind(this.filesAdded,this)),this.upl.instance.bind("FileUploaded",_.bind(this.fileUploaded,this)),this.upl.instance.bind("UploadProgress",_.bind(this.uploaderProgress,this))},mediaModal:function(e){e.preventDefault();var t=this;"undefined"!=typeof i&&i.close();var i=wp.media.frames.customHeader=wp.media({title:"Select An Image",library:{type:"image"},button:{text:"insert image"},multiple:!1});"wp-image"==this.blockType&&i.on("select",function(){var e=i.state().get("selection").first().toJSON();t.setImg(e)}),i.open()},filesAdded:function(){this.$bar=e('<div class="upload-bg"><div class="upload-bar"><div class="upload-percent"></div><div><p class="upload-label"></p></div>'),this.$el.find(e("."+this.blockType)).append(this.$bar)},uploaderProgress:function(e,t){this.$bar.find(".upload-percent").css("width",e.total.percent+"%"),this.$bar.find(".upload-label").html("Uploading "+t.name)},fileUploaded:function(t,i,n){this.Img=e.parseJSON(n.response),this.setImg(this.Img)},setImg:function(t){var i=this,n="wp-image-"+t.id,o=this.$el.find(e("."+this.blockType)),l=_.template(e("#image-placeholder").html());o.html(l({id:n,url:i.getImgURL(t,"full")}))},getImgURL:function(e,t){var i=this;for(var n in e.sizes)e.sizes.hasOwnProperty(n)&&(i.imgSizes[n]=e.sizes[n].url);return i.imgSizes[t]},imgSize:function(t){var i=e(t.currentTarget),n=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-size").removeClass("selected"),i.addClass("selected"),i.hasClass("size-thumbnail")?n.attr("src",this.imgSizes.thumbnail):i.hasClass("size-medium")?n.attr("src",this.imgSizes.medium):i.hasClass("size-full")&&n.attr("src",this.imgSizes.full))},imgAlign:function(t){var i=e(t.currentTarget),n=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-align").removeClass("selected"),i.addClass("selected"),i.hasClass("align-left")?n.attr("class","img-file alignleft"):i.hasClass("align-center")?n.attr("class","img-file aligncenter"):i.hasClass("align-right")?n.attr("class","img-file alignright"):n.attr("class","img-file alignone"))},removeImg:function(e){e.preventDefault(),this.render(),this.afterRender()},dragOver:function(e){e.stopPropagation(),e.preventDefault(),this.$el.find(".drag-drop-area").addClass("drag-over")},dragLeave:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")},dropUpload:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")}}),i.View=Backbone.View.extend({el:"#content-blocks",events:{"click #add-block":"blockMenu","change #post-title":"updateTitle","click #publish":"savePost"},initialize:function(){this.container=e("#content"),this.addBtn=e("#blocksSelect"),this.counter=0,this.render(),this.$el.sortable({handle:".move",connectWith:".content-blocks",placeholder:"blocks-placeholder",start:function(t,i){i.placeholder.height(i.item.outerHeight()),e(".mce-tinymce").hide()}})},render:function(){},blockMenu:function(e){e.preventDefault(),this.addBtn.toggleClass("active")},addBlock:function(t,n){var o="wp-"+t;this.counter++;var l=new i.Block({wp_id:"block_"+this.counter,type:o}),s=i[n];this.collection.add(l),this.addBtn.removeClass("active");var a=new s({model:l});this.$el.append(a.render().el),a.isEditable&&this.setEditable(e("#"+l.get("wp_id")))},setEditable:function(e){var t=e.find(".editable").attr("id");tinymce.execCommand("mceAddEditor",!1,t)},savePost:function(){console.log(i.blocks.toJSON()),alert("Here we need to get all the data from post.Blocks collection, serialize it and save on the database. The post.Data model will hold the content when the post is loaded, then it should pass it to the post.Blocks collection to rebuild the content blocks.")}}),i.view=new i.View({collection:i.blocks}),tinymce.init({selector:".editable",add_unload_trigger:!1,schema:"html5",inline:!0,fixed_toolbar_container:"#wp-editor-toolbar",menubar:!1,toolbar:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",statusbar:!1}),e("#add-block").on("click",function(t){t.preventDefault(),e("#blocksSelect").toggleClass("active")}),e(window).scroll(function(){e("#wp-editor-toolbar").css(t(e("#postdivrich"),e("#wpadminbar"))?{position:"fixed",top:32,zIndex:9999,width:e("#postdivrich").width()}:{position:"static"})})})}(jQuery),window.wp=window.wp||{},window.wp.contentBlocks=window.wp.contentBlocks||{},function(e,t){"use strict";function i(t,i){n&&n.dialog("close"),n=e("#wp-content-block-modal-"+t).dialog({title:i,dialogClass:"wp-dialog"})}var n;e(document).ready(function(){e("body").on("click","#content-block-group-tabs a",function(t){var i,n=e(t.currentTarget);return i=n.attr("href"),n.parent().addClass("tabs").siblings("li").removeClass("tabs"),e("#content-block-group-tabs").siblings(".tabs-panel").hide(),e(i).show(),!1}),e("body").on("click",".block-list li",function(n){var o,l,s,a=e(n.currentTarget);return o=a.data("context"),l=a.data("js-callback"),s=a.data("title"),o&&l&&l in t?t[l](o,s):i(o,s),!1})})}(jQuery,window.wp.contentBlocks),function(e){"use strict";e(function(){function t(e,t){var i=e.offset().left,n=e.offset().top,o=e.outerHeight(!0),l=e.outerWidth(!0),s=n+o,a=i+l,r=t.offset().left,c=t.offset().top,d=t.outerHeight(!0),h=t.outerWidth(!0),u=c+d,p=r+h;return c>s||n>u||r>a||i>p?!1:!0}var i=i||{};i.Data=Backbone.Model.extend({defaults:{title:"Your title here",permalink:"",content:{},meta:{}}}),e.get(ajaxurl,{action:"get_cb_button_tpl"}).done(function(e){i.blocksBtn_tpl=e,i.blockMenu=new i.BlocksContainerView({collection:i.blocksCol})}),i.Uploader=Backbone.Model.extend({initialize:function(){this.params={browse_button:this.get("browse_button"),container:this.get("container"),drop_element:this.get("drop_element"),multi_selectioni:this.get("multi_selectioni")},this.$settings=_.extend({},this.get("defaults"),this.params),this.response={},this.instance=new plupload.Uploader(this.$settings),this.init()},init:function(){var e=this,t=e.instance;setTimeout(function(){t.init(),t.bind("FilesAdded",_.bind(e.filesAdded,this)),t.bind("QueueChanged",_.bind(e.queueChanged,this)),t.trigger("DisableBrowse",!0)},10)},logIt:function(){console.log(this.instance)},filesAdded:function(e){e.start()},queueChanged:function(e){e.start(),e.refresh()}}),i.BlockModel=Backbone.Model.extend(),i.BlocksContainer=Backbone.Collection.extend({url:ajaxurl,model:i.BlockModel,group:function(e){return _(this.filter(function(t){return t.get("group")==e}))},search:function(e){if(""==e)return this;var t=new RegExp(e,"gi");return _(this.filter(function(e){return t.test(e.get("name"))}))}}),i.blocksCol=new i.BlocksContainer,i.BlockButton=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(i.blocksBtn_tpl),this.render()},render:function(){return this.$el.html(this.template({name:this.model.get("name"),slug:this.model.get("slug"),icon:this.model.get("icon"),view:this.model.get("view")})),this}}),i.BlocksContainerView=Backbone.View.extend({el:"#blocksSelect",events:{"keyup #blocks-search":"search","click .customBlock":"addBlock"},initialize:function(){_.bindAll(this,"render"),this.listenTo(this.collection,"reset",this.render),this.defaults=e("#defaults-container"),this.others=e("#others-container"),this.results=e("#results-container");var t={action:"get_content_blocks"},i=this;this.collection.fetch({data:e.param(t),success:function(){i.defaultBlocks=i.collection.group("default"),i.otherBlocks=i.collection.group("other"),i.render()},error:function(e,t){console.log(" Service request failure: "+e),console.log(t.responseText)}})},render:function(){var e=this;e.defaults.html("").append("<h3>Default Blocks</h3>"),e.others.html("").append("<h3>Other Blocks</h3>"),e.defaultBlocks.each(function(t){var n=new i.BlockButton({model:t});e.defaults.append(n.render().el)}),e.otherBlocks.each(function(t){var n=new i.BlockButton({model:t});e.others.append(n.render().el)})},renderList:function(e){this.defaults.html(""),this.others.html(""),this.results.html("");var t=this;e.each(function(e){var n=new i.BlockButton({model:e,collection:t.collection});t.results.append(n.render().el)})},search:function(t){var i=e(t.target).val();i?this.renderList(this.collection.search(i)):(this.results.html(""),this.render())},addBlock:function(t){var n=this.collection.findWhere({slug:e(t.currentTarget).attr("data-type")}),o=n.get("slug"),l=n.get("view");i.view.addBlock(o,l)}}),i.Block=Backbone.Model.extend({defaults:{wp_id:0,remove:!0,move:!0}}),i.Blocks=Backbone.Collection.extend({model:i.Block}),i.blocks=new i.Blocks,i.BlockView=Backbone.View.extend({tagName:"div",className:"content-block",tpl:"#wp-text",isEditable:!1,events:{"click .remove":"destroy","click .move-up":"moveUp","click .move-down":"moveDown"},init:function(){},beforeRender:function(){},afterRender:function(){},initialize:function(){this.beforeRender(),this.trigger("beforeRender"),this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(e(this.tpl).html()),this.events&&(this.events=_.defaults(this.events,i.BlockView.prototype.events)),this.delegateEvents(this.events),this.init(),this.render(),this.afterRender(),this.trigger("afterRender")},render:function(){return this.$el.html(this.template({wp_id:this.model.get("wp_id"),block_type:this.model.get("type"),block_content:this.model.get("body"),remove:this.model.get("remove"),move:this.model.get("move"),editable:this.isEditable})),this},unrender:function(){this.$el.remove()},destroy:function(){this.model.destroy()},moveUp:function(t){var i=e(t.currentTarget).parents(".content-block"),n=i.prev(".content-block");n.insertAfter(i)},moveDown:function(t){var i=e(t.currentTarget).parents(".content-block"),n=i.next(".content-block");n.insertBefore(i)}}),i.textView=i.BlockView.extend({tpl:"#wp-text",isEditable:!0}),i.quoteView=i.BlockView.extend({tpl:"#wp-quote"}),i.codeView=i.BlockView.extend({tpl:"#wp-code",isEditable:!0,init:function(){console.log(this.model)}}),i.embedView=i.BlockView.extend({tpl:"#wp-embed"}),i.tweetView=i.BlockView.extend({tpl:"#wp-tweet"}),i.imgView=i.BlockView.extend({tpl:"#wp-image",events:{"click .open-modal":"mediaModal","click .remove-img":"removeImg","click .opt-size":"imgSize","click .opt-align":"imgAlign","dragover .drag-drop":"dragOver","dragleave .drag-drop":"dragLeave","drop .drag-drop":"dropUpload"},init:function(){this.imgSizes={},this.blockType=this.model.get("type")},afterRender:function(){var e=this.model.get("wp_id");this.upl=new i.Uploader({browse_button:"wp-browse-button-"+e,container:"wp-img-ui-"+e,drop_element:"wp-drag-drop-"+e,multi_selection:!1,defaults:ceux_plupload}),this.upl.instance.bind("FilesAdded",_.bind(this.filesAdded,this)),this.upl.instance.bind("FileUploaded",_.bind(this.fileUploaded,this)),this.upl.instance.bind("UploadProgress",_.bind(this.uploaderProgress,this))},mediaModal:function(e){e.preventDefault();var t=this;"undefined"!=typeof i&&i.close();var i=wp.media.frames.customHeader=wp.media({title:"Select An Image",library:{type:"image"},button:{text:"insert image"},multiple:!1});"wp-image"==this.blockType&&i.on("select",function(){var e=i.state().get("selection").first().toJSON();t.setImg(e)}),i.open()},filesAdded:function(){this.$bar=e('<div class="upload-bg"><div class="upload-bar"><div class="upload-percent"></div><div><p class="upload-label"></p></div>'),this.$el.find(e("."+this.blockType)).append(this.$bar)},uploaderProgress:function(e,t){this.$bar.find(".upload-percent").css("width",e.total.percent+"%"),this.$bar.find(".upload-label").html("Uploading "+t.name)},fileUploaded:function(t,i,n){this.Img=e.parseJSON(n.response),this.setImg(this.Img)},setImg:function(t){var i=this,n="wp-image-"+t.id,o=this.$el.find(e("."+this.blockType)),l=_.template(e("#image-placeholder").html());o.html(l({id:n,url:i.getImgURL(t,"full")}))},getImgURL:function(e,t){var i=this;for(var n in e.sizes)e.sizes.hasOwnProperty(n)&&(i.imgSizes[n]=e.sizes[n].url);return i.imgSizes[t]},imgSize:function(t){var i=e(t.currentTarget),n=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-size").removeClass("selected"),i.addClass("selected"),i.hasClass("size-thumbnail")?n.attr("src",this.imgSizes.thumbnail):i.hasClass("size-medium")?n.attr("src",this.imgSizes.medium):i.hasClass("size-full")&&n.attr("src",this.imgSizes.full))},imgAlign:function(t){var i=e(t.currentTarget),n=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-align").removeClass("selected"),i.addClass("selected"),i.hasClass("align-left")?n.attr("class","img-file alignleft"):i.hasClass("align-center")?n.attr("class","img-file aligncenter"):i.hasClass("align-right")?n.attr("class","img-file alignright"):n.attr("class","img-file alignone"))},removeImg:function(e){e.preventDefault(),this.render(),this.afterRender()},dragOver:function(e){e.stopPropagation(),e.preventDefault(),this.$el.find(".drag-drop-area").addClass("drag-over")},dragLeave:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")},dropUpload:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")}}),i.View=Backbone.View.extend({el:"#content-blocks",events:{"click #add-block":"blockMenu","change #post-title":"updateTitle","click #publish":"savePost"},initialize:function(){this.container=e("#content"),this.addBtn=e("#blocksSelect"),this.counter=0,this.render(),this.$el.sortable({handle:".move",connectWith:".content-blocks",placeholder:"blocks-placeholder",start:function(t,i){i.placeholder.height(i.item.outerHeight()),e(".mce-tinymce").hide()}})},render:function(){},blockMenu:function(e){e.preventDefault(),this.addBtn.toggleClass("active")},addBlock:function(t,n){var o="wp-"+t;this.counter++;var l=new i.Block({wp_id:"block_"+this.counter,type:o}),s=i[n];this.collection.add(l),this.addBtn.removeClass("active");var a=new s({model:l});this.$el.append(a.render().el),a.isEditable&&this.setEditable(e("#"+l.get("wp_id")))},setEditable:function(e){var t=e.find(".editable").attr("id");tinymce.execCommand("mceAddEditor",!1,t)},savePost:function(){console.log(i.blocks.toJSON()),alert("Here we need to get all the data from post.Blocks collection, serialize it and save on the database. The post.Data model will hold the content when the post is loaded, then it should pass it to the post.Blocks collection to rebuild the content blocks.")}}),i.view=new i.View({collection:i.blocks}),tinymce.init({selector:".editable",add_unload_trigger:!1,schema:"html5",inline:!0,fixed_toolbar_container:"#wp-editor-toolbar",menubar:!1,toolbar:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",statusbar:!1}),e("#add-block").on("click",function(t){t.preventDefault(),e("#blocksSelect").toggleClass("active")}),e(window).scroll(function(){e("#wp-editor-toolbar").css(t(e("#postdivrich"),e("#wpadminbar"))?{position:"fixed",top:32,zIndex:9999,width:e("#postdivrich").width()}:{position:"static"})})})}(jQuery),!function(e){"use strict";e(function(){function t(e,t){var i=e.offset().left,n=e.offset().top,o=e.outerHeight(!0),l=e.outerWidth(!0),s=n+o,a=i+l,r=t.offset().left,c=t.offset().top,d=t.outerHeight(!0),h=t.outerWidth(!0),u=c+d,p=r+h;return c>s||n>u||r>a||i>p?!1:!0}var i=i||{};i.Data=Backbone.Model.extend({defaults:{title:"Your title here",permalink:"",content:{},meta:{}}}),e.get(ajaxurl,{action:"get_cb_button_tpl"}).done(function(e){i.blocksBtn_tpl=e,i.blockMenu=new i.BlocksContainerView({collection:i.blocksCol})}),i.Uploader=Backbone.Model.extend({initialize:function(){this.objects={browse_button:this.get("browse_button"),container:this.get("container"),drop_element:this.get("drop_element")},this.$settings=_.extend({},this.get("defaults"),this.objects),this.instance=new plupload.Uploader(this.$settings),this.init()},init:function(){var e=this,t=e.instance;setTimeout(function(){t.init(),t.bind("FilesAdded",_.bind(e.filesAdded,this)),t.bind("QueueChanged",_.bind(e.queueChanged,this)),t.trigger("DisableBrowse",!0)},10)},logIt:function(){console.log(this.instance)},filesAdded:function(e){console.log("FilesAdded"),e.start()},queueChanged:function(e){console.log("QueueChanged"),e.start(),e.refresh()}}),i.BlockModel=Backbone.Model.extend(),i.BlocksContainer=Backbone.Collection.extend({url:ajaxurl,model:i.BlockModel,group:function(e){return _(this.filter(function(t){return t.get("group")==e}))},search:function(e){if(""==e)return this;var t=new RegExp(e,"gi");return _(this.filter(function(e){return t.test(e.get("name"))}))}}),i.blocksCol=new i.BlocksContainer,i.BlockButton=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(i.blocksBtn_tpl),this.render()},render:function(){return this.$el.html(this.template({name:this.model.get("name"),slug:this.model.get("slug"),icon:this.model.get("icon"),view:this.model.get("view")})),this}}),i.BlocksContainerView=Backbone.View.extend({el:"#blocksSelect",events:{"keyup #blocks-search":"search","click .customBlock":"addBlock"},initialize:function(){_.bindAll(this,"render"),this.listenTo(this.collection,"reset",this.render),this.defaults=e("#defaults-container"),this.others=e("#others-container"),this.results=e("#results-container");var t={action:"get_content_blocks"},i=this;this.collection.fetch({data:e.param(t),success:function(){i.defaultBlocks=i.collection.group("default"),i.otherBlocks=i.collection.group("other"),i.render()},error:function(e,t){console.log(" Service request failure: "+e),console.log(t.responseText)}})},render:function(){var e=this;e.defaults.html("").append("<h3>Default Blocks</h3>"),e.others.html("").append("<h3>Other Blocks</h3>"),e.defaultBlocks.each(function(t){var n=new i.BlockButton({model:t});e.defaults.append(n.render().el)}),e.otherBlocks.each(function(t){var n=new i.BlockButton({model:t});e.others.append(n.render().el)})},renderList:function(e){this.defaults.html(""),this.others.html(""),this.results.html("");var t=this;e.each(function(e){var n=new i.BlockButton({model:e,collection:t.collection});t.results.append(n.render().el)})},search:function(t){var i=e(t.target).val();i?this.renderList(this.collection.search(i)):(this.results.html(""),this.render())},addBlock:function(t){var n=this.collection.findWhere({slug:e(t.currentTarget).attr("data-type")}),o=n.get("slug"),l=n.get("view");i.view.addBlock(o,l)}}),i.Block=Backbone.Model.extend({defaults:{wp_id:0,remove:!0,move:!0}}),i.Blocks=Backbone.Collection.extend({model:i.Block}),i.blocks=new i.Blocks,i.BlockView=Backbone.View.extend({tagName:"div",className:"content-block",tpl:"#wp-text",isEditable:!1,events:{"click .remove":"destroy","click .move-up":"moveUp","click .move-down":"moveDown"},init:function(){},onRender:function(){},initialize:function(){this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(e(this.tpl).html()),this.events&&(this.events=_.defaults(this.events,i.BlockView.prototype.events)),this.delegateEvents(this.events),this.init(),this.render(),this.onRender(),this.trigger("onRender")},render:function(){return this.$el.html(this.template({wp_id:this.model.get("wp_id"),block_type:this.model.get("type"),block_content:this.model.get("body"),remove:this.model.get("remove"),move:this.model.get("move"),editable:this.isEditable})),this},unrender:function(){this.$el.remove()},destroy:function(){this.model.destroy()},moveUp:function(t){var i=e(t.currentTarget).parents(".content-block"),n=i.prev(".content-block");n.insertAfter(i)},moveDown:function(t){var i=e(t.currentTarget).parents(".content-block"),n=i.next(".content-block");n.insertBefore(i)}}),i.textView=i.BlockView.extend({tpl:"#wp-text",isEditable:!0}),i.quoteView=i.BlockView.extend({tpl:"#wp-quote"}),i.codeView=i.BlockView.extend({tpl:"#wp-code",isEditable:!0,init:function(){console.log(this.model)}}),i.embedView=i.BlockView.extend({tpl:"#wp-embed"}),i.tweetView=i.BlockView.extend({tpl:"#wp-tweet"}),i.imgView=i.BlockView.extend({tpl:"#wp-image",events:{"click .open-modal":"mediaModal","click .remove-img":"removeImg","click .opt-size":"imgSize","click .opt-align":"imgAlign","dragover .drag-drop":"dragOver","dragleave .drag-drop":"dragLeave","drop .drag-drop":"dropUpload"},init:function(){"wp-image"==this.model.get("type")&&(this.imgSizes={})},onRender:function(){console.log("Plupload");var e=this.model.get("wp_id");this.upl=new i.Uploader({browse_button:"wp-browse-button-"+e,container:"wp-img-ui-"+e,drop_element:"wp-drag-drop-"+e,defaults:ceux_plupload})},mediaModal:function(t){t.preventDefault();var i=this;this.blockType=this.model.get("type"),i.$el.find(e("."+this.blockType)),"undefined"!=typeof n&&n.close();var n=wp.media.frames.customHeader=wp.media({title:"Select An Image",library:{type:"image"},button:{text:"insert image"},multiple:!1});"wp-image"==this.blockType&&n.on("select",function(){var e=n.state().get("selection").first().toJSON();e.getURL=function(t){for(var n in e.sizes)e.sizes.hasOwnProperty(n)&&(i.imgSizes[n]=e.sizes[n].url);return i.imgSizes[t]},console.log(this.atributes.toJSON())}),n.open()},imgSize:function(t){var i=e(t.currentTarget),n=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-size").removeClass("selected"),i.addClass("selected"),i.hasClass("size-thumbnail")?n.attr("src",this.imgSizes.thumbnail):i.hasClass("size-medium")?n.attr("src",this.imgSizes.medium):i.hasClass("size-full")&&n.attr("src",this.imgSizes.full))},imgAlign:function(t){var i=e(t.currentTarget),n=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-align").removeClass("selected"),i.addClass("selected"),i.hasClass("align-left")?n.attr("class","img-file alignleft"):i.hasClass("align-center")?n.attr("class","img-file aligncenter"):i.hasClass("align-right")?n.attr("class","img-file alignright"):n.attr("class","img-file alignone"))},removeImg:function(e){e.preventDefault(),this.render(),this.onRender()},dragOver:function(e){e.stopPropagation(),e.preventDefault(),this.$el.find(".drag-drop-area").addClass("drag-over")},dragLeave:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")},dropUpload:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")}}),i.View=Backbone.View.extend({el:"#content-blocks",events:{"click #add-block":"blockMenu","change #post-title":"updateTitle","click #publish":"savePost"},initialize:function(){this.container=e("#content"),this.addBtn=e("#blocksSelect"),this.counter=0,this.render(),this.$el.sortable({handle:".move",connectWith:".content-blocks",placeholder:"blocks-placeholder",start:function(t,i){i.placeholder.height(i.item.outerHeight()),e(".mce-tinymce").hide()}})},render:function(){},blockMenu:function(e){e.preventDefault(),this.addBtn.toggleClass("active")},addBlock:function(t,n){var o="wp-"+t;this.counter++;var l=new i.Block({wp_id:"block_"+this.counter,type:o}),s=i[n];this.collection.add(l),this.addBtn.removeClass("active");var a=new s({model:l});this.$el.append(a.render().el),a.isEditable&&this.setEditable(e("#"+l.get("wp_id")))},setEditable:function(e){var t=e.find(".editable").attr("id");tinymce.execCommand("mceAddEditor",!1,t)},savePost:function(){console.log(i.blocks.toJSON()),alert("Here we need to get all the data from post.Blocks collection, serialize it and save on the database. The post.Data model will hold the content when the post is loaded, then it should pass it to the post.Blocks collection to rebuild the content blocks.")}}),i.view=new i.View({collection:i.blocks}),tinymce.init({selector:".editable",add_unload_trigger:!1,schema:"html5",inline:!0,fixed_toolbar_container:"#wp-editor-toolbar",menubar:!1,toolbar:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",statusbar:!1}),e("#add-block").on("click",function(t){t.preventDefault(),e("#blocksSelect").toggleClass("active")}),e(window).scroll(function(){e("#wp-editor-toolbar").css(t(e("#postdivrich"),e("#wpadminbar"))?{position:"fixed",top:32,zIndex:9999,width:e("#postdivrich").width()}:{position:"static"})})})}(jQuery);